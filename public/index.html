<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bridge NLP Chat</title>
  <!-- Load ethers.js from multiple CDNs with fallbacks -->
  <script>
    function loadEthers() {
      console.log('Attempting to load ethers.js from primary CDN');
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
      script.type = 'text/javascript';
      script.onerror = function() {
        console.warn('Primary ethers.js CDN failed, trying second CDN...');
        var script2 = document.createElement('script');
        script2.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
        script2.type = 'text/javascript';
        script2.onerror = function() {
          console.warn('Second ethers.js CDN failed, trying third CDN...');
          var script3 = document.createElement('script');
          script3.src = 'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js';
          script3.type = 'text/javascript';
          script3.onerror = function() {
            console.error('All ethers.js CDNs failed to load');
            window.ethersLoadFailed = true;
          };
          script3.onload = function() {
            console.log('ethers.js loaded successfully from third CDN');
            window.ethersLoaded = true;
          };
          document.head.appendChild(script3);
        };
        script2.onload = function() {
          console.log('ethers.js loaded successfully from second CDN');
          window.ethersLoaded = true;
        };
        document.head.appendChild(script2);
      };
      script.onload = function() {
        console.log('ethers.js loaded successfully from primary CDN');
        window.ethersLoaded = true;
      };
      document.head.appendChild(script);
    }
    
    // Load ethers immediately
    loadEthers();
  </script>
  <!-- Add Stargate SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@layerzerolabs/stargate-ui@latest/element.js"></script>
  <!-- Check ethers.js availability and load a local version if needed -->
  <script>
    // Final check and ethers verification before DOMContentLoaded
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded - checking ethers availability:', typeof ethers);
      
      if (typeof ethers === 'undefined') {
        console.error('All ethers.js CDNs failed, trying emergency local load');
        
        // Will add ethers status message after DOM is fully loaded
        setTimeout(function() {
          const chatMessagesElement = document.getElementById('chat-messages');
          if (chatMessagesElement) {
            // Create an alert to inform the user
            const messageElement = document.createElement('div');
            messageElement.className = 'message system-message transaction-error';
            messageElement.innerHTML = 'Loading blockchain libraries... Please wait.';
            chatMessagesElement.appendChild(messageElement);
            
            // Try one more CDN as emergency fallback
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js';
            script.onload = function() {
              console.log('Emergency ethers.js loaded successfully');
              messageElement.innerHTML = 'Blockchain libraries loaded successfully! You can now proceed.';
              messageElement.className = 'message system-message transaction-success';
              // Manually dispatch an event that ethers is ready
              window.ethersReady = true;
              document.dispatchEvent(new Event('ethersLoaded'));
            };
            script.onerror = function() {
              console.error('All attempts to load ethers.js failed');
              messageElement.innerHTML = 'Failed to load blockchain libraries. Please check your internet connection and refresh the page.';
            };
            document.head.appendChild(script);
          }
        }, 500);
      } else {
        console.log('ethers.js verified available at DOMContentLoaded');
        window.ethersReady = true;
        document.dispatchEvent(new Event('ethersLoaded'));
      }
    });
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
      color: #333;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background-color: #3B48DF;
      color: white;
      padding: 20px 0;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    
    .header h1 {
      margin: 0;
    }
    
    .wallet-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .wallet-button {
      background-color: white;
      color: #3B48DF;
      border: none;
      border-radius: 30px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-weight: bold;
    }
    
    .wallet-button:hover {
      background-color: #f0f0f0;
    }
    
    .wallet-info {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 5px 10px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .wallet-info .balance {
      font-weight: bold;
    }
    
    .wallet-info .address {
      font-family: monospace;
    }
    
    .chat-container {
      background-color: white;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      height: 500px;
      display: flex;
      flex-direction: column;
    }
    
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 10px;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 80%;
      line-height: 1.4;
      position: relative;
    }
    
    .user-message {
      align-self: flex-end;
      background-color: #3B48DF;
      color: white;
      margin-left: auto;
    }
    
    .system-message {
      align-self: flex-start;
      background-color: #F0F2F5;
      color: #333;
    }
    
    .message-input {
      display: flex;
      gap: 10px;
    }
    
    input[type="text"] {
      flex-grow: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 30px;
      font-size: 16px;
      outline: none;
    }
    
    button {
      background-color: #3B48DF;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #2D3AC3;
    }
    
    .examples {
      margin-top: 20px;
      background-color: #F0F2F5;
      border-radius: 10px;
      padding: 15px;
    }
    
    .examples h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    
    .examples ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .examples li {
      margin-bottom: 5px;
      cursor: pointer;
      color: #3B48DF;
    }
    
    .notification {
      background-color: #10B981;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      animation: fadeOut 5s forwards;
    }
    
    @keyframes fadeOut {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; display: none; }
    }
    
    pre {
      background-color: #F0F2F5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      font-size: 14px;
    }
    
    .transaction-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    
    .transaction-pending {
      background-color: #FEF3C7;
      color: #92400E;
    }
    
    .transaction-success {
      background-color: #D1FAE5;
      color: #065F46;
    }
    
    .transaction-error {
      background-color: #FEE2E2;
      color: #B91C1C;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s linear 0.25s, opacity 0.25s 0s;
    }
    
    .modal.open {
      visibility: visible;
      opacity: 1;
      transition-delay: 0s;
    }
    
    .modal-content {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }
    
    .modal-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: #6B7280;
      padding: 0;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Model Selector */
    #model-selector {
      padding: 10px 15px;
      border-top: 1px solid #eee;
      background-color: #f9f9f9;
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }
    
    #model-selector label {
      margin-right: 10px;
      font-weight: bold;
    }
    
    #ai-model {
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: white;
      flex-grow: 1;
      max-width: 200px;
    }
    
    #ai-model:focus {
      border-color: #4a6cf7;
      outline: none;
    }
    
    /* Ethers Status Message */
    #ethers-status {
      margin: 10px;
      padding: 10px;
      text-align: center;
      font-size: 0.9rem;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Natural Language Bridge</h1>
      <div class="wallet-section">
        <div id="wallet-info" style="display: none;" class="wallet-info">
          <span class="balance" id="wallet-balance">0 ETH</span>
          <span class="address" id="wallet-address">0x1234...5678</span>
        </div>
        <button id="connect-wallet" class="wallet-button">Connect Wallet</button>
        <button id="disconnect-wallet" class="wallet-button" style="display: none;">Disconnect</button>
      </div>
    </div>
    
    <div class="chat-container">
      <div id="chat-messages"></div>
      <div id="loading-indicator">Loading...</div>
      <div id="ethers-status" class="system-message"></div>
      <div id="chat-input-container">
        <textarea id="chat-input" placeholder="Send 10 USDC from Base to Arbitrum..." rows="3"></textarea>
        <button id="send-button">Send</button>
      </div>
      <div id="model-selector">
        <label>Select AI Model:</label>
        <select id="ai-model">
          <option value="openai">OpenAI (GPT-4)</option>
          <option value="gemini">Google Gemini</option>
        </select>
      </div>
    </div>
    
    <div class="examples">
      <h3>Example commands:</h3>
      <ul>
        <li class="example-command">Bridge 10 USDC to Arbitrum</li>
        <li class="example-command">Send 0.5 ETH from Ethereum to Optimism</li>
        <li class="example-command">Transfer 50 USDT to Polygon with fast gas</li>
      </ul>
    </div>
  </div>
  
  <!-- Transaction confirmation modal -->
  <div id="transaction-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Confirm Transaction</h2>
      <p id="transaction-details"></p>
      
      <div id="chain-selection-container">
        <h3>Source Chain</h3>
        <div id="source-chain-options" class="chain-selection"></div>
        
        <h3>Destination Chain</h3>
        <div id="destination-chain-options" class="chain-selection"></div>
      </div>
      
      <div id="token-selection-container">
        <h3>Token</h3>
        <div id="token-options" class="token-selection"></div>
      </div>
      
      <div id="amount-container">
        <h3>Amount</h3>
        <div class="amount-input">
          <input type="text" id="amount-input" placeholder="0.0">
          <span id="token-symbol">USDC</span>
        </div>
      </div>
      
      <div id="gas-preference-container">
        <h3>Gas Preference</h3>
        <div class="gas-preferences">
          <div class="gas-option" data-preference="low">Low</div>
          <div class="gas-option selected" data-preference="normal">Normal</div>
          <div class="gas-option" data-preference="high">High</div>
        </div>
      </div>
      
      <div id="balance-info"></div>
      
      <div class="modal-buttons">
        <button id="cancel-transaction" class="modal-button cancel-button">Cancel</button>
        <button id="confirm-transaction" class="modal-button confirm-button">Confirm</button>
      </div>
    </div>
  </div>
  
  <script>
    // Global transaction tracking variables
    let activeTxHash = null;
    let currentTransaction = null;
    let currentAccount = { address: null, isConnected: false };
    
    // Global variables for DOM elements to ensure they are initialized properly
    let chatMessages;
    let chatInput;
    let sendButton;
    let loadingIndicator;
    let ethersStatus;
    let modalElement;
    let modalConfirmBtn;
    let modalCancelBtn;
    let modalCloseBtn;
    let aiModelSelector;
    
    // Initialize the DOM elements after the document is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize DOM elements
      chatMessages = document.getElementById('chat-messages');
      chatInput = document.getElementById('chat-input');
      sendButton = document.getElementById('send-button');
      loadingIndicator = document.getElementById('loading-indicator');
      ethersStatus = document.getElementById('ethers-status');
      modalElement = document.getElementById('transaction-modal');
      modalConfirmBtn = document.getElementById('confirm-transaction');
      modalCancelBtn = document.getElementById('cancel-transaction');
      modalCloseBtn = document.querySelector('.close');
      aiModelSelector = document.getElementById('ai-model');
      
      // Show ethers loading status to user
      ethersStatus.innerHTML = "Loading blockchain libraries...";
      ethersStatus.style.display = "block";
      
      // Add welcome message
      addSystemMessage("Hello! I can help you bridge tokens between chains using natural language. Try saying something like \"Send 100 USDC to Arbitrum\" or \"Bridge ETH from Ethereum to Base\".");
      
      // Check ethers loading status
      setTimeout(function() {
        if (typeof ethers !== 'undefined') {
          ethersStatus.innerHTML = "Blockchain libraries loaded successfully!";
          ethersStatus.classList.add('transaction-success');
          // Hide the message after 3 seconds
          setTimeout(() => {
            ethersStatus.style.display = "none";
          }, 3000);
        } else {
          ethersStatus.innerHTML = "Still loading blockchain libraries... This may take a moment.";
          ethersStatus.classList.add('transaction-pending');
        }
      }, 1000);
      
      // Add console log to show if wallet is detected
      console.log('Checking for wallet...');
      if (window.ethereum) {
        console.log('Wallet detected!');
        checkConnection();
      } else {
        console.log('No wallet detected');
        addSystemMessage("No wallet detected. Please install MetaMask or another Ethereum wallet to use this app.", "transaction-error");
      }
      
      // Set up event listeners
      sendButton.addEventListener('click', handleSendMessage);
      
      chatInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          handleSendMessage();
        }
      });
      
      // Set up modal event listeners
      if (modalConfirmBtn) {
        modalConfirmBtn.addEventListener('click', function() {
          executeTransaction();
        });
      }
      
      if (modalCancelBtn) {
        modalCancelBtn.addEventListener('click', function() {
          closeModal();
        });
      }
      
      if (modalCloseBtn) {
        modalCloseBtn.addEventListener('click', function() {
          closeModal();
        });
      }
      
      // AI model selection listener
      if (aiModelSelector) {
        aiModelSelector.addEventListener('change', function() {
          const selectedModel = aiModelSelector.value;
          addSystemMessage(`Switching to ${selectedModel === 'openai' ? 'OpenAI (GPT-4)' : 'Google Gemini'} model for processing your requests.`);
          localStorage.setItem('preferred_ai_model', selectedModel);
        });
        
        // Load saved preference if available
        const savedModel = localStorage.getItem('preferred_ai_model');
        if (savedModel) {
          aiModelSelector.value = savedModel;
        }
      }
      
      // Set ethers status when ethers is loaded or failed
      document.addEventListener('ethersLoaded', function() {
        if (ethersStatus) {
          ethersStatus.innerHTML = "Blockchain libraries loaded successfully!";
          ethersStatus.classList.add('transaction-success');
          ethersStatus.classList.remove('transaction-pending');
          // Hide the message after 3 seconds
          setTimeout(() => {
            ethersStatus.style.display = "none";
          }, 3000);
        }
      });
      
      // UI initialization
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
    });
    
    // Helper function to add messages to the chat
    function addMessage(text, type) {
      // Make sure chatMessages is initialized
      if (!chatMessages) chatMessages = document.getElementById('chat-messages');
      if (!chatMessages) return;
      
      const messageElement = document.createElement('div');
      messageElement.className = `message ${type}-message`;
      messageElement.innerHTML = text;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return messageElement;
    }
    
    function addSystemMessage(text, className = "") {
      // Make sure chatMessages is initialized
      if (!chatMessages) chatMessages = document.getElementById('chat-messages');
      if (!chatMessages) return;
      
      const messageElement = document.createElement('div');
      messageElement.className = `message system-message ${className}`;
      messageElement.innerHTML = text;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return messageElement;
    }
  
    // Handle sending a message
    function handleSendMessage() {
      if (!chatInput) return;
      
      const messageText = chatInput.value.trim();
      
      if (messageText === '') return;
      
      // Add user message to the chat
      addMessage(messageText, 'user');
      
      // Clear input field
      chatInput.value = '';
      
      // Process the command
      processCommand(messageText);
    }
    
    // Process the user's command
    async function processCommand(command) {
      if (!loadingIndicator) return;
      
      loadingIndicator.style.display = 'block';
      
      try {
        // Get the currently selected AI model
        const selectedModel = aiModelSelector ? aiModelSelector.value : 'openai';
        
        const response = await fetch('/api/process-command', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            command,
            walletAddress: currentAccount.address,
            aiModel: selectedModel
          })
        });
        
        const data = await response.json();
        
        // Display response
        addSystemMessage(data.message);
        
        // Check if we have a transaction
        if (data.transaction) {
          currentTransaction = data.transaction;
          showConfirmationModal(data.transaction);
        }
      } catch (error) {
        console.error('Error processing command:', error);
        addSystemMessage(`Error: ${error.message || 'Could not process your command.'}`, 'transaction-error');
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }
  </script>
</body>
</html> 